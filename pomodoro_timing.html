<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer con Firebase</title>
    <!-- Meta tag per PWA -->
    <meta name="theme-color" content="#1f2937"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pomodoro">
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/100/000000/tomato.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }
        .timer-display { font-weight: 900; transition: color 0.5s ease; }
        .btn { transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .task-item { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .clear-btn { opacity: 0.6; transition: opacity 0.2s ease; }
        .clear-btn:hover { opacity: 1; }
        #db-modal-overlay { background-color: rgba(0,0,0,0.7); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body id="app-body" class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <!-- Schermata di caricamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-gray-400">Connessione a Firebase...</p>
    </div>

    <div id="app-container" class="w-full max-w-md mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl hidden">
        
        <h1 id="session-title" class="text-2xl font-bold text-center mb-2 text-cyan-400 transition-colors duration-500">Sessione di Lavoro</h1>
        <p class="text-center text-gray-400 mb-6">Rimani concentrato, ce la puoi fare!</p>

        <div id="timer-display" class="timer-display text-8xl md-text-9xl text-center my-8 text-white">25:00</div>

        <div class="mb-6">
            <label for="task-input" class="block text-sm font-medium text-gray-300 mb-2">Attività Corrente:</label>
            <input type="text" id="task-input" class="w-full bg-gray-700 border-2 border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" placeholder="Es: Scrivere la relazione...">
        </div>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="start-btn" class="btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Inizia</button>
            <button id="pause-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hidden">Pausa</button>
            <button id="reset-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Reset</button>
        </div>

        <div id="settings" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <div>
                <label for="work-duration" class="block text-sm font-medium text-gray-300 mb-1">Lavoro (min):</label>
                <input type="number" id="work-duration" value="25" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
            <div>
                <label for="break-duration" class="block text-sm font-medium text-gray-300 mb-1">Pausa (min):</label>
                <input type="number" id="break-duration" value="5" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
        </div>

        <div id="task-list-container" class="mt-8 pt-4 border-t border-gray-700 hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-300">Attività Completate</h2>
                <button id="clear-tasks-btn" title="Pulisci lista" class="clear-btn text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
             </div>
             <ul id="task-list" class="space-y-2"></ul>
        </div>
    </div>

    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PWA SETUP ---
        const manifest = {
            "name": "Pomodoro Timer", "short_name": "Pomodoro", "start_url": ".", "display": "standalone",
            "background_color": "#1f2937", "theme_color": "#1f2937",
            "description": "Un semplice timer Pomodoro per la gestione del tempo.",
            "icons": [{"src": "https://img.icons8.com/plasticine/192/000000/tomato.png", "sizes": "192x192", "type": "image/png"}, {"src": "https://img.icons8.com/plasticine/512/000000/tomato.png", "sizes": "512x512", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('install', event => { event.waitUntil(caches.open('pomodoro-cache-v1').then(cache => cache.addAll(['/']))); });
                self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(response => response || fetch(event.request))); });
            `;
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('ServiceWorker registrato.'))
                    .catch(err => console.log('Registrazione ServiceWorker fallita: ', err));
            });
        }
        
        // --- VARIABILI GLOBALI E CONFIGURAZIONE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pomodoro-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId; 
        let timerStateRef, tasksCollectionRef;

        // Riferimenti agli elementi del DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const body = document.getElementById('app-body');
        const sessionTitle = document.getElementById('session-title');
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const workDurationInput = document.getElementById('work-duration');
        const breakDurationInput = document.getElementById('break-duration');
        const taskInput = document.getElementById('task-input');
        const taskListContainer = document.getElementById('task-list-container');
        const taskList = document.getElementById('task-list');
        const settingsDiv = document.getElementById('settings');
        const clearTasksBtn = document.getElementById('clear-tasks-btn');

        // Variabili di stato del timer
        let timer;
        let isRunning = false;
        let isWorkSession = true;
        let totalSeconds = 25 * 60;
        let audioContext;
        let notificationSound;
        let unsubscribeTimer, unsubscribeTasks;

        // --- FLUSSO DI INIZIALIZZAZIONE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Utente autenticato:", userId);
                
                timerStateRef = doc(db, `artifacts/${appId}/users/${userId}/settings/timerState`);
                tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                
                setupTimerListener();
                setupTasksListener();

            } else {
                console.log("Nessun utente, tento l'accesso anonimo...");
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Errore durante l'accesso anonimo:", error);
                    loadingOverlay.innerHTML = "<p>Errore di connessione a Firebase.</p>";
                }
            }
        });

        function setupTimerListener() {
            unsubscribeTimer = onSnapshot(timerStateRef, (docSnap) => {
                if (docSnap.exists()) {
                    const savedState = docSnap.data();
                    loadTimerState(savedState);
                } else {
                    resetTimer(false); 
                }
                loadingOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }, (error) => {
                console.error("Errore nel listener del timer:", error);
            });
        }

        function setupTasksListener() {
            unsubscribeTasks = onSnapshot(query(tasksCollectionRef), (snapshot) => {
                taskList.innerHTML = '';
                const tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                tasks.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                tasks.forEach(task => createTaskElement(task.text));
                taskListContainer.classList.toggle('hidden', tasks.length === 0);
            });
        }
        
        // --- LOGICA DEL TIMER E GESTIONE DELLO STATO ---
        async function saveTimerState() {
            if (!userId) return;
            const state = { totalSeconds, isWorkSession, isRunning, timestamp: serverTimestamp() };
            try {
                await setDoc(timerStateRef, state, { merge: true });
            } catch (error) {
                console.error("Errore nel salvataggio dello stato:", error);
            }
        }

        function loadTimerState(savedState) {
            isWorkSession = savedState.isWorkSession;
            updateSessionUI();

            if (savedState.isRunning && savedState.timestamp) {
                const timePassed = Math.floor((Date.now() - savedState.timestamp.toMillis()) / 1000);
                const newTotalSeconds = savedState.totalSeconds - timePassed;
                
                if (newTotalSeconds > 0) {
                    totalSeconds = newTotalSeconds;
                    if (!isRunning) startTimer(false);
                } else {
                    isWorkSession = !savedState.isWorkSession;
                    totalSeconds = (isWorkSession ? parseInt(workDurationInput.value, 10) : parseInt(breakDurationInput.value, 10)) * 60;
                    updateSessionUI();
                }
            } else {
                totalSeconds = savedState.totalSeconds;
                if(isRunning) pauseTimer();
            }
            updateDisplay();
        }

        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;
            document.title = `${formattedTime} - ${isWorkSession ? 'Lavoro' : 'Pausa'}`;
        }

        function updateSessionUI() {
             if (isWorkSession) {
                body.classList.remove('bg-emerald-900'); body.classList.add('bg-gray-900');
                sessionTitle.textContent = "Sessione di Lavoro";
                sessionTitle.classList.remove('text-emerald-300'); sessionTitle.classList.add('text-cyan-400');
            } else {
                body.classList.remove('bg-gray-900'); body.classList.add('bg-emerald-900');
                sessionTitle.textContent = "Pausa";
                sessionTitle.classList.remove('text-cyan-400'); sessionTitle.classList.add('text-emerald-300');
            }
        }

        function switchSession() {
            clearInterval(timer);
            isRunning = false;

            if (isWorkSession) {
                logTask();
                showNotification("Sessione di lavoro terminata! È ora di una pausa.");
                isWorkSession = false;
                totalSeconds = parseInt(breakDurationInput.value, 10) * 60;
            } else {
                showNotification("La pausa è finita! Si torna al lavoro.");
                isWorkSession = true;
                totalSeconds = parseInt(workDurationInput.value, 10) * 60;
            }
            updateSessionUI();
            updateDisplay();
            startTimer();
        }

        function countdown() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
            } else {
                if (notificationSound) notificationSound();
                switchSession();
            }
        }

        async function startTimer(requestPerms = true) {
            if (isRunning) return;
            if (requestPerms && Notification.permission === "default") {
                await Notification.requestPermission();
            }
            if (!audioContext) setupAudio();
            isRunning = true;
            timer = setInterval(countdown, 1000);
            startBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');
            settingsDiv.querySelectorAll('input').forEach(input => input.disabled = true);
            taskInput.disabled = true;
            saveTimerState();
        }

        function pauseTimer() {
            if (!isRunning) return;
            isRunning = false;
            clearInterval(timer);
            startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden');
            saveTimerState();
        }

        async function resetTimer(doSave = true) {
            clearInterval(timer);
            isRunning = false;
            isWorkSession = true;
            totalSeconds = parseInt(workDurationInput.value, 10) * 60;
            updateDisplay();
            updateSessionUI();
            startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden');
            settingsDiv.querySelectorAll('input').forEach(input => input.disabled = false);
            taskInput.disabled = false;
            taskInput.value = "";
            document.title = "Pomodoro Timer";
            if (doSave) await saveTimerState();
        }
        
        // --- GESTIONE ATTIVITÀ ---
        function createTaskElement(taskText) {
            const li = document.createElement('li');
            li.className = 'task-item bg-gray-700 p-3 rounded-lg flex items-center';
            const icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-cyan-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
            li.innerHTML = `${icon}<span>${taskText}</span>`;
            taskList.appendChild(li);
        }

        async function logTask() {
            const taskText = taskInput.value.trim();
            if (taskText) {
                try {
                    await addDoc(tasksCollectionRef, { text: taskText, createdAt: serverTimestamp() });
                } catch (error) {
                    console.error("Errore nell'aggiungere l'attività:", error);
                }
            }
            taskInput.value = "";
        }

        async function clearTasks() {
            const querySnapshot = await getDocs(tasksCollectionRef);
            querySnapshot.forEach(async (doc) => {
                try {
                    await deleteDoc(doc.ref);
                } catch (error) {
                    console.error("Errore nella cancellazione dell'attività:", error);
                }
            });
        }
        
        // --- NOTIFICHE E AUDIO ---
        function showNotification(message) {
            const notificationOptions = {
                body: message,
                icon: "https://img.icons8.com/plasticine/192/000000/tomato.png",
                badge: "https://img.icons8.com/plasticine/100/000000/tomato.png",
                vibrate: [200, 100, 200]
            };

            if (Notification.permission === "granted") {
                // **MODIFICA PRINCIPALE: Usa il Service Worker se disponibile**
                if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification("Pomodoro Timer", notificationOptions);
                    });
                } else {
                    // Fallback per browser senza Service Worker
                    new Notification("Pomodoro Timer", notificationOptions);
                }
            }
        }
        
        function setupAudio() { /* ... logica audio invariata ... */ }

        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', () => startTimer());
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', () => resetTimer());
        clearTasksBtn.addEventListener('click', clearTasks);

        workDurationInput.addEventListener('change', () => {
            if (!isRunning && isWorkSession) {
                totalSeconds = parseInt(workDurationInput.value, 10) * 60;
                updateDisplay();
                saveTimerState();
            }
        });

        breakDurationInput.addEventListener('change', () => {
            if (!isRunning && !isWorkSession) {
                totalSeconds = parseInt(breakDurationInput.value, 10) * 60;
                updateDisplay();
                saveTimerState();
            }
        });
    </script>
</body>
</html>
