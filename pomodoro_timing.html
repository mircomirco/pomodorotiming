<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <!-- Meta tag per PWA -->
    <meta name="theme-color" content="#1f2937"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pomodoro">
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/100/000000/tomato.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }
        .timer-display { font-weight: 900; transition: color 0.5s ease; }
        .btn { transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .task-item { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .control-btn { opacity: 0.6; transition: opacity 0.2s ease; }
        .control-btn:hover { opacity: 1; }
    </style>
</head>
<body id="app-body" class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        
        <h1 id="session-title" class="text-2xl font-bold text-center mb-2 text-cyan-400 transition-colors duration-500">Sessione di Lavoro</h1>
        <p id="session-subtitle" class="text-center text-gray-400 mb-6">Rimani concentrato, ce la puoi fare!</p>

        <div id="timer-display" class="timer-display text-8xl md-text-9xl text-center my-8 text-white">25:00</div>

        <div class="mb-6">
            <label for="task-input" class="block text-sm font-medium text-gray-300 mb-2">Attività Corrente:</label>
            <input type="text" id="task-input" class="w-full bg-gray-700 border-2 border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none" placeholder="Es: Scrivere la relazione...">
        </div>

        <!-- Controlli Principali -->
        <div id="main-controls" class="flex justify-center space-x-4 mb-8">
            <button id="start-btn" class="btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Inizia</button>
            <button id="pause-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hidden">Pausa</button>
            <button id="reset-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Reset</button>
        </div>
        
        <!-- Controlli di Conferma Salvataggio -->
        <div id="save-controls" class="hidden text-center mb-8">
             <p class="text-gray-300 mb-4">Vuoi salvare questo blocco di lavoro?</p>
             <div class="flex justify-center space-x-4">
                <button id="save-block-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Salva Blocco</button>
                <button id="discard-block-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full shadow-lg">Scarta</button>
             </div>
        </div>

        <div id="settings" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <div>
                <label for="work-duration" class="block text-sm font-medium text-gray-300 mb-1">Lavoro (min):</label>
                <input type="number" id="work-duration" value="25" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
            <div>
                <label for="break-duration" class="block text-sm font-medium text-gray-300 mb-1">Pausa (min):</label>
                <input type="number" id="break-duration" value="5" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
        </div>

        <div id="task-list-container" class="mt-8 pt-4 border-t border-gray-700 hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-300">Attività Completate</h2>
                <div class="flex space-x-4">
                    <button id="export-csv-btn" title="Esporta in CSV" class="control-btn text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    <button id="clear-tasks-btn" title="Pulisci lista" class="control-btn text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
             </div>
             <ul id="task-list" class="space-y-2"></ul>
        </div>
    </div>

    <script>
        // --- PWA SETUP ---
        const manifest = {
            "name": "Pomodoro Timer", "short_name": "Pomodoro", "start_url": "./", "display": "standalone",
            "background_color": "#1f2937", "theme_color": "#1f2937",
            "description": "Un semplice timer Pomodoro per la gestione del tempo.",
            "icons": [{"src": "https://img.icons8.com/plasticine/192/000000/tomato.png", "sizes": "192x192", "type": "image/png"}, {"src": "https://img.icons8.com/plasticine/512/000000/tomato.png", "sizes": "512x512", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        // Riferimenti agli elementi del DOM
        const body = document.getElementById('app-body');
        const sessionTitle = document.getElementById('session-title');
        const sessionSubtitle = document.getElementById('session-subtitle');
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const workDurationInput = document.getElementById('work-duration');
        const breakDurationInput = document.getElementById('break-duration');
        const taskInput = document.getElementById('task-input');
        const taskListContainer = document.getElementById('task-list-container');
        const taskList = document.getElementById('task-list');
        const settingsDiv = document.getElementById('settings');
        const clearTasksBtn = document.getElementById('clear-tasks-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const mainControls = document.getElementById('main-controls');
        const saveControls = document.getElementById('save-controls');
        const saveBlockBtn = document.getElementById('save-block-btn');
        const discardBlockBtn = document.getElementById('discard-block-btn');

        // Variabili di stato del timer
        let timer;
        let isRunning = false;
        let isWorkSession = true;
        let totalSeconds = 25 * 60;
        let completedWorkDuration = 25;
        let audioContext;
        let notificationSound;

        // --- FLUSSO DI INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadTasks();
            resetTimer();
        });

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('pomodoroSettings'));
            if (settings) {
                workDurationInput.value = settings.workDuration || 25;
                breakDurationInput.value = settings.breakDuration || 5;
            }
        }

        function saveSettings() {
            const settings = {
                workDuration: parseInt(workDurationInput.value, 10),
                breakDuration: parseInt(breakDurationInput.value, 10)
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
        }

        function loadTasks() {
            const tasks = JSON.parse(localStorage.getItem('pomodoroTasks')) || [];
            taskList.innerHTML = '';
            tasks.forEach(task => createTaskElement(task.text, task.duration));
            taskListContainer.classList.toggle('hidden', tasks.length === 0);
        }

        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;
            document.title = `${formattedTime} - ${isWorkSession ? 'Lavoro' : 'Pausa'}`;
        }

        function updateSessionUI() {
             if (isWorkSession) {
                body.classList.remove('bg-emerald-900'); body.classList.add('bg-gray-900');
                sessionTitle.textContent = "Sessione di Lavoro";
                sessionSubtitle.textContent = "Rimani concentrato, ce la puoi fare!";
                sessionTitle.classList.remove('text-emerald-300'); sessionTitle.classList.add('text-cyan-400');
            } else {
                body.classList.remove('bg-gray-900'); body.classList.add('bg-emerald-900');
                sessionTitle.textContent = "Pausa";
                sessionSubtitle.textContent = "Fai una pausa, te la sei meritata!";
                sessionTitle.classList.remove('text-cyan-400'); sessionTitle.classList.add('text-emerald-300');
            }
        }

        function promptToSaveBlock() {
            if (notificationSound) notificationSound();
            showNotification("Sessione di lavoro terminata! Vuoi salvare?");
            mainControls.classList.add('hidden');
            saveControls.classList.remove('hidden');
            taskInput.disabled = true;
        }

        function startBreak() {
            saveControls.classList.add('hidden');
            mainControls.classList.remove('hidden');
            
            isWorkSession = false;
            totalSeconds = parseInt(breakDurationInput.value, 10) * 60;
            updateSessionUI();
            updateDisplay();
            startTimer();
        }

        function countdown() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
            } else {
                clearInterval(timer);
                isRunning = false;
                if (isWorkSession) {
                    promptToSaveBlock();
                } else {
                    resetTimer();
                }
            }
        }

        function startTimer(requestPerms = true) {
            if (isRunning) return;
            if (requestPerms && Notification.permission === "default") {
                Notification.requestPermission();
            }
            if (!audioContext) setupAudio();
            isRunning = true;
            
            if (isWorkSession) {
                completedWorkDuration = parseInt(workDurationInput.value, 10);
            }

            timer = setInterval(countdown, 1000);
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            settingsDiv.querySelectorAll('input').forEach(input => input.disabled = true);
            taskInput.disabled = false;
        }

        function pauseTimer() {
            if (!isRunning) return;
            isRunning = false;
            clearInterval(timer);
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
        }

        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            isWorkSession = true;
            totalSeconds = parseInt(workDurationInput.value, 10) * 60;
            updateDisplay();
            updateSessionUI();
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            mainControls.classList.remove('hidden');
            saveControls.classList.add('hidden');
            settingsDiv.querySelectorAll('input').forEach(input => input.disabled = false);
            taskInput.disabled = false;
            taskInput.value = "";
            document.title = "Pomodoro Timer";
        }
        
        // --- GESTIONE ATTIVITÀ ---
        function createTaskElement(taskText, duration) {
            const li = document.createElement('li');
            li.className = 'task-item bg-gray-700 p-3 rounded-lg flex items-center justify-between';
            const icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-cyan-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
            const textSpan = `<span class="truncate">${taskText || "Attività non specificata"}</span>`;
            const durationSpan = `<span class="text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded-full">${duration} min</span>`;
            li.innerHTML = `<div class="flex items-center min-w-0">${icon}${textSpan}</div>${durationSpan}`;
            taskList.appendChild(li);
        }

        function logTask() {
            const tasks = JSON.parse(localStorage.getItem('pomodoroTasks')) || [];
            const taskText = taskInput.value.trim();
            
            const newTask = {
                text: taskText || "Attività non specificata",
                duration: completedWorkDuration,
                savedAt: new Date().toISOString() // Salva data e ora
            };

            tasks.push(newTask);
            localStorage.setItem('pomodoroTasks', JSON.stringify(tasks));
            loadTasks(); // Ricarica la lista per visualizzare il nuovo task
            taskInput.value = "";
        }

        function clearTasks() {
            if (confirm("Sei sicuro di voler cancellare tutte le attività salvate?")) {
                localStorage.removeItem('pomodoroTasks');
                loadTasks();
            }
        }
        
        // --- ESPORTAZIONE CSV ---
        function exportToCSV() {
            const tasks = JSON.parse(localStorage.getItem('pomodoroTasks')) || [];
            if (tasks.length === 0) {
                alert("Nessuna attività da esportare.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data,Ora,Attività,Durata (min)\r\n"; // Intestazione CSV

            tasks.forEach(task => {
                const date = new Date(task.savedAt);
                const formattedDate = date.toLocaleDateString('it-IT');
                const formattedTime = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const row = `"${formattedDate}","${formattedTime}","${task.text.replace(/"/g, '""')}","${task.duration}"`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pomodoro_tasks.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- NOTIFICHE E AUDIO ---
        function showNotification(message) {
            if (Notification.permission === "granted") {
                new Notification("Pomodoro Timer", {
                    body: message,
                    icon: "https://img.icons8.com/plasticine/192/000000/tomato.png",
                });
            }
        }
        
        function setupAudio() { /* ... logica audio invariata ... */ }

        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', () => startTimer());
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        clearTasksBtn.addEventListener('click', clearTasks);
        exportCsvBtn.addEventListener('click', exportToCSV);
        saveBlockBtn.addEventListener('click', () => {
            logTask();
            startBreak();
        });
        discardBlockBtn.addEventListener('click', startBreak);
        
        workDurationInput.addEventListener('change', () => {
            saveSettings();
            // Aggiorna il display solo se il timer non è in esecuzione e siamo in una sessione di lavoro
            if (!isRunning && isWorkSession) {
                totalSeconds = parseInt(workDurationInput.value, 10) * 60;
                updateDisplay();
            }
        });

        breakDurationInput.addEventListener('change', () => {
            saveSettings();
            // Aggiorna il display solo se il timer non è in esecuzione e siamo in una sessione di pausa
            if (!isRunning && !isWorkSession) {
                totalSeconds = parseInt(breakDurationInput.value, 10) * 60;
                updateDisplay();
            }
        });
    </script>
</body>
</html>
